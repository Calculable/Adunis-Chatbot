<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>ADUNIS Chatbot</title>
      <link rel = "stylesheet" type = "text/css" href = "css/style.css" />

  </head>
  <body>

  	<h1>Willkommen beim ADUNIS Chatbot</h1>

    <form action="/" method="POST">

    <label for="userText">Nachricht</label>
    <input type="text" id="userText" name="userText">

    <button type="submit">Senden</button>

    </form>
	<div id="parent">
		<img class="inline" id="left" src="img/robot.gif" width="400" height="400"><br><br>
		<h2 class="block" th:if="${answer?.answerMessage}" th:text="'Der Roboter sagt: '"></h2>
		<h2 class="block" th:if="${answer?.answerMessage}" th:text="${answer.answerMessage}"></h2>
	</div>



	<div id="sentiment" class="block">
		<h3 th:if="${answer?.sentimentScore}" th:text="'User Sentiment bei: ' + ${answer.sentimentScore}"></h3>
	</div>

    <div id="intend" class="block">
        <h3 th:if="${answer?.intend}" th:text="'Erkannter Intend: ' + ${answer.intend}"></h3>
        <h3 th:if="${answer?.intendConfidenceScore}" th:text="'Erkannt mit Sicherheit: ' + ${answer.intendConfidenceScore}"></h3>
    </div>

    <div id="user-data-fields" class="block" th:if="${answer?.userDataFields != null and answer.userDataFields.size() &gt; 0}" >
        <h3>Werte</h3>


        <div th:each="entry : ${answer.userDataFields}">
            <strong><span th:text="${entry.key} + ': '"/></strong>
            <span th:text="${#strings.isEmpty(entry.value) ? '?' : entry.value}"/>
         </div>


        <h3 th:text="${answer.hasAllNecessaryInformation()? 'Alle benötigten Informationen liegen vor.' : 'Noch nicht alle benötigten Informationen liegen vor.'}"></h3>

    </div>

    <div id="fulfillment" style="background-color: lightgreen; display: inline-block" th:if="${answer?.hasAllNecessaryInformation()}">

        <h3>Anfrage erfolgreich abgeschlossen</h3>
        <div th:if="${answer.courseChangeFulfillment}" th:insert="fulfillmentFragments/courseChangeFulfillmentFragment.html :: content (fulfillment=${answer.courseChangeFulfillment})"> </div>
        <div th:if="${answer.exmatriculationFulfillment}" th:insert="fulfillmentFragments/exmatriculationFulfillmentFragment.html :: content (fulfillment=${answer.exmatriculationFulfillment})"> </div>
        <div th:if="${answer.pauseStudyFulfillment}" th:insert="fulfillmentFragments/pauseStudyFulfillmentFragment.html :: content (fulfillment=${answer.pauseStudyFulfillment})"> </div>
        <div th:if="${answer.semesterReportFulfillment}" th:insert="fulfillmentFragments/semesterReportFulfillmentFragment.html :: content (fulfillment=${answer.semesterReportFulfillment})"> </div>
        <div th:if="${answer.studyReportFulfillment}" th:insert="fulfillmentFragments/studyReportFulfillmentFragment.html :: content (fulfillment=${answer.studyReportFulfillment})"> </div>

    </div>


    <script  th:inline="javascript">

        //see https://stackoverflow.com/questions/56426744/how-to-play-the-output-audio-from-dialogflow-int-array

        function playOutput(byteArray){

            var arrayBuffer = new ArrayBuffer(byteArray.length);
            var bufferView = new Uint8Array(arrayBuffer);
            for (let i = 0; i < byteArray.length; i++) {
                bufferView[i] = byteArray[i];
            }

            let audioContext = new AudioContext();
            let outputSource;
            try {
                if(arrayBuffer.byteLength > 0){
                    console.log(arrayBuffer.byteLength);
                    audioContext.decodeAudioData(arrayBuffer,
                        function(buffer){
                            audioContext.resume();
                            outputSource = audioContext.createBufferSource();
                            outputSource.connect(audioContext.destination);
                            outputSource.buffer = buffer;
                            outputSource.start(0);
                        },
                        function(){
                            console.log(arguments);
                        });
                }
            } catch(e) {
                console.log(e);
            }
        }

        /*<![CDATA[*/

        var audioOutput = /*[[${answer?.outputAudio}]]*/ undefined;
        if (audioOutput) {
            playOutput(audioOutput)
        }
        /*]]>*/

    </script>
	
  </body>
</html>